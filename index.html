<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpieza Digital – Marketplace Mundial</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --coral: #ff6b6b; --turquoise: #0d9488; --pink: #ff8fa3; }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, var(--turquoise), var(--coral)); color:white; padding-bottom:100px; min-height:100vh; }
        
        .bottom-nav {
            position:fixed; bottom:0; left:0; right:0; height:90px; background:rgba(0,0,0,0.92); backdrop-filter:blur(30px);
            display:flex; align-items:center; justify-content:center; z-index:9999; padding-bottom:env(safe-area-inset-bottom,20px);
        }
        .nav-container {
            background:rgba(255,255,255,0.08); backdrop-filter:blur(20px); border-radius:50px; padding:14px 36px;
            display:flex; gap:48px; box-shadow:0 8px 32px rgba(0,0,0,0.5);
        }
        .nav-item { display:flex; flex-direction:column; align-items:center; gap:6px; color:#888; font-size:11px; font-weight:600; transition:all 0.3s; cursor:pointer; }
        .nav-item i { font-size:26px; }
        .nav-item.active, .nav-item.active i { color:var(--coral); }
        .nav-item.active i { transform:scale(1.2); }

        .container { max-width:1400px; margin:0 auto; padding:20px; }
        header { text-align:center; padding:100px 20px 60px; }
        .logo { font-size:clamp(3.5rem,10vw,7rem); font-weight:900; background:linear-gradient(45deg,#fff,var(--pink)); -webkit-background-clip:text; color:transparent; }

        .glass { background:rgba(255,255,255,0.12); backdrop-filter:blur(20px); border-radius:32px; padding:40px; margin:40px 0; border:1px solid rgba(255,255,255,0.2); }

        .services-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(340px,1fr)); gap:28px; }
        .service-card { background:rgba(255,255,255,0.15); border-radius:28px; overflow:hidden; transition:0.4s; position:relative; }
        .service-card:hover { transform:translateY(-12px); box-shadow:0 30px 60px rgba(0,0,0,0.5); }
        .profile-pic { width:90px; height:90px; border-radius:50%; object-fit:cover; border:4px solid var(--coral); margin:20px auto; display:block; }
        .photos { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin:16px 0; }
        .photos img { width:100px; height:100px; border-radius:16px; object-fit:cover; }
        .private { filter:blur(8px); transition:0.4s; user-select:none; }
        .private:hover { filter:none; }
        .delete-btn { position:absolute; top:12px; right:12px; background:#ff0000; color:white; padding:8px 14px; border-radius:50px; font-size:0.9rem; cursor:pointer; display:none; }
        .service-card.mine .delete-btn { display:block; }

        #form { display:grid; gap:16px; max-width:600px; margin:0 auto; }
        input, textarea, button { padding:18px; border-radius:16px; border:none; font-size:16px; }
        input, textarea { background:rgba(255,255,255,0.2); color:white; }
        button { background:var(--coral); color:white; font-weight:bold; cursor:pointer; }
        .loading { text-align:center; padding:40px; opacity:0.8; }
        .error { background:rgba(255,0,0,0.2); padding:20px; border-radius:16px; text-align:center; margin:20px 0; }
        .success { background:rgba(0,255,0,0.2); padding:20px; border-radius:16px; text-align:center; margin:20px 0; }
    </style>
</head>
<body>

    <nav class="bottom-nav">
        <div class="nav-container">
            <div class="nav-item active" data-section="home"><i class="fas fa-home"></i><span>Home</span></div>
            <div class="nav-item" data-section="add"><i class="fas fa-plus-circle"></i><span>Ofrecer</span></div>
        </div>
    </nav>

    <div class="container">
        <header>
            <h1 class="logo">Limpieza Digital</h1>
            <p style="font-size:1.6rem;">Marketplace mundial – Gratis y permanente con Supabase</p>
        </header>

        <section id="home" class="glass">
            <h2 style="text-align:center; margin-bottom:30px;">Cleaners disponibles</h2>
            <div class="services-grid" id="services"><div class="loading">Cargando...</div></div>
            <div id="error" class="error" style="display:none;"></div>
        </section>

        <section id="add" class="glass">
            <h2 style="text-align:center; margin-bottom:30px;">Publica tu servicio</h2>
            <form id="form">
                <input type="text" id="name" placeholder="Nombre completo" required>
                <input type="text" id="city" placeholder="Ciudad y País" required>
                <input type="tel" id="phone" placeholder="Teléfono (+57...)" required>
                <input type="email" id="email" placeholder="Email" required>
                <input type="text" id="price" placeholder="Precio (ej: $25/hora)" required>
                <textarea id="desc" placeholder="Descripción de tus servicios" rows="4" required></textarea>
                <input type="file" id="profile" accept="image/*" required>
                <input type="file" id="photos" accept="image/*" multiple>
                <button type="submit">PUBLICAR AHORA</button>
            </form>
            <div id="form-msg" style="display:none;"></div>
        </section>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // TU SUPABASE REAL
        const supabaseUrl = 'https://tdaxbmmbenbpokyznquq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkYXhibW1iZW5icG9reXpucXVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NjMzNTMsImV4cCI6MjA4MDUzOTM1M30.sUX_iSfGRyw0rRArT7x24XCEIjSobtAbORZQa8aVjGU';
        const supabase = createClient(supabaseUrl, supabaseKey);

        const servicesDiv = document.getElementById('services');
        const errorDiv = document.getElementById('error');
        const formMsg = document.getElementById('form-msg');
        const form = document.getElementById('form');
        const myId = localStorage.getItem('myCleanerId');

        // SUSCRIBIRSE A CAMBIOS EN TIEMPO REAL
        supabase.channel('cleaners-changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'cleaners' }, () => loadServices())
            .subscribe();

        async function loadServices() {
            const { data, error } = await supabase.from('cleaners').select('*').order('created_at', { ascending: false });
            if (error) {
                errorDiv.innerHTML = `Error: ${error.message}`;
                errorDiv.style.display = 'block';
                return;
            }
            servicesDiv.innerHTML = '';
            if (!data || data.length === 0) {
                servicesDiv.innerHTML = '<p style="text-align:center; opacity:0.8;">¡Sé el primero en publicar!</p>';
                return;
            }
            data.forEach(s => {
                const isMine = s.id === myId;
                const card = document.createElement('div');
                card.className = `service-card ${isMine ? 'mine' : ''}`;
                card.innerHTML = `
                    <img class="profile-pic" src="${s.profile}" alt="${s.name}" onerror="this.src='https://via.placeholder.com/90?text=Perfil'">
                    <div style="padding:20px; text-align:center;">
                        <h3 style="margin:12px 0; font-size:1.5rem;">${s.name}</h3>
                        <p><i class="fas fa-map-marker-alt"></i> ${s.city}</p>
                        <p style="margin:16px 0; opacity:0.9; line-height:1.5;">${s.desc}</p>
                        <div class="photos">
                            ${s.photos ? s.photos.map(p => `<img src="${p}" onerror="this.style.display='none'">`).join('') : ''}
                        </div>
                        <div style="margin:20px 0; font-size:1.1rem;">
                            <div class="private">Teléfono: ${s.phone}</div>
                            <div class="private">Email: ${s.email}</div>
                        </div>
                        <div style="font-size:1.8rem; color:var(--coral); font-weight:bold; margin:16px 0;">
                            ${s.price}
                        </div>
                        ${isMine ? `<button class="delete-btn" onclick="deleteService('${s.id}')">Borrar mi anuncio</button>` : ''}
                    </div>
                `;
                servicesDiv.appendChild(card);
            });
        }

        // PUBLICAR SERVICIO
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = "Publicando...";
            formMsg.style.display = 'none';

            try {
                const profileFile = document.getElementById('profile').files[0];
                if (!profileFile) throw new Error('Selecciona una foto de perfil');

                // Subir foto de perfil
                const { data: profileData, error: profileError } = await supabase.storage
                    .from('profiles')
                    .upload(`public/${Date.now()}_${profileFile.name}`, profileFile);
                if (profileError) throw profileError;
                const profileUrl = supabase.storage.from('profiles').getPublicUrl(profileData.path).data.publicUrl;

                // Subir fotos adicionales
                const photoFiles = document.getElementById('photos').files;
                const photoUrls = [];
                for (let i = 0; i < photoFiles.length; i++) {
                    const file = photoFiles[i];
                    const { data, error } = await supabase.storage
                        .from('photos')
                        .upload(`public/${Date.now()}_${file.name}`, file);
                    if (error) throw error;
                    photoUrls.push(supabase.storage.from('photos').getPublicUrl(data.path).data.publicUrl);
                }

                // Guardar en base de datos
                const { data: newService, error } = await supabase
                    .from('cleaners')
                    .insert({
                        name: document.getElementById('name').value,
                        city: document.getElementById('city').value,
                        phone: document.getElementById('phone').value,
                        email: document.getElementById('email').value,
                        price: document.getElementById('price').value,
                        desc: document.getElementById('desc').value,
                        profile: profileUrl,
                        photos: photoUrls
                    })
                    .select();

                if (error) throw error;

                if (!myId) localStorage.setItem('myCleanerId', newService[0].id);

                formMsg.innerHTML = '<div class="success">¡Publicado con éxito en todo el mundo!</div>';
                formMsg.style.display = 'block';
                form.reset();
                document.querySelector('[data-section="home"]').click();
            } catch (err) {
                console.error(err);
                formMsg.innerHTML = `<div class="error">Error: ${err.message}</div>`;
                formMsg.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        // BORRAR SOLO EL DUEÑO
        window.deleteService = async (id) => {
            if (confirm('¿Borrar tu anuncio para siempre?')) {
                const { error } = await supabase.from('cleaners').delete().eq('id', id);
                if (error) alert('Error: ' + error.message);
                else if (localStorage.getItem('myCleanerId') === id) localStorage.removeItem('myCleanerId');
            }
        };

        // NAVEGACIÓN
        document.querySelectorAll('.nav-item').forEach(el => {
            el.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
                el.classList.add('active');
                document.getElementById(el.dataset.section)?.scrollIntoView({behavior:'smooth'});
            });
        });

        // CARGAR INICIAL
        loadServices();
    </script>
</body>
</html>
